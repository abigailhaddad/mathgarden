<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Proof by Elimination</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas id="game"></canvas>

  <script src="js/levels.js"></script>
  <script src="js/engine.js"></script>
  <script src="js/renderer.js"></script>
  <script>
    (function() {
      'use strict';

      var canvas = document.getElementById('game');
      var engine = LiarsGarden.createEngine();
      var renderer = LiarsGarden.createRenderer(canvas);
      var STATE = LiarsGarden.STATE;

      function fitCanvas() {
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        renderer.resize(engine.getState());
        renderer.render(engine.getState());
      }
      window.addEventListener('resize', fitCanvas);

      engine.onStateChange = function(gs) {
        renderer.render(gs);
      };

      // Keyboard
      document.addEventListener('keydown', function(e) {
        var gs = engine.getState();

        // Title screen: any key starts choosing lives
        if (gs.state === STATE.TITLE) {
          engine.chooseLives();
          return;
        }

        // Choose lives screen: handle number input
        if (gs.state === STATE.CHOOSE_LIVES) {
          var result = renderer.handleLivesKey(e.key);
          if (result !== null) {
            engine.startGame(result);
          } else {
            renderer.render(engine.getState());
          }
          return;
        }

        if (e.key === 'r' || e.key === 'R') {
          if (gs.state === STATE.GAME_OVER || gs.state === STATE.WIN) {
            engine.restartGame();
          } else {
            engine.restartLevel();
          }
          return;
        }

        var keyMap = {
          ArrowUp: [-1, 0], ArrowDown: [1, 0], ArrowLeft: [0, -1], ArrowRight: [0, 1],
          w: [-1, 0], s: [1, 0], a: [0, -1], d: [0, 1],
          W: [-1, 0], S: [1, 0], A: [0, -1], D: [0, 1],
        };

        if (keyMap[e.key]) {
          e.preventDefault();
          var dir = keyMap[e.key];
          engine.move(dir[0], dir[1]);
        }
      });

      // Mouse click â€” for start button and game over/win
      canvas.addEventListener('click', function(e) {
        var gs = engine.getState();
        if (gs.state === STATE.TITLE) {
          // Check if click is on start button
          var btn = LiarsGarden.createRenderer._titleBtn;
          if (btn) {
            var rect = canvas.getBoundingClientRect();
            var mx = e.clientX - rect.left;
            var my = e.clientY - rect.top;
            if (mx >= btn.x && mx <= btn.x + btn.w && my >= btn.y && my <= btn.y + btn.h) {
              engine.chooseLives();
            }
          }
          return;
        }
        if (gs.state === STATE.GAME_OVER || gs.state === STATE.WIN) {
          engine.restartGame();
          return;
        }
      });

      // Touch
      var touchStartX = 0, touchStartY = 0;
      canvas.addEventListener('touchstart', function(e) {
        var gs = engine.getState();
        if (gs.state === STATE.TITLE || gs.state === STATE.CHOOSE_LIVES || gs.state === STATE.GAME_OVER || gs.state === STATE.WIN) {
          // Handled by click
          return;
        }
        var t = e.touches[0];
        touchStartX = t.clientX;
        touchStartY = t.clientY;
      }, {passive: true});

      canvas.addEventListener('touchend', function(e) {
        var gs = engine.getState();
        if (gs.state === STATE.TITLE || gs.state === STATE.CHOOSE_LIVES || gs.state === STATE.GAME_OVER || gs.state === STATE.WIN) return;
        var t = e.changedTouches[0];
        var dx = t.clientX - touchStartX;
        var dy = t.clientY - touchStartY;
        var threshold = 30;

        if (Math.abs(dx) < threshold && Math.abs(dy) < threshold) return;

        if (Math.abs(dx) > Math.abs(dy)) {
          engine.move(0, dx > 0 ? 1 : -1);
        } else {
          engine.move(dy > 0 ? 1 : -1, 0);
        }
      }, {passive: true});

      // Animation loop
      function animate() {
        renderer.render(engine.getState());
        requestAnimationFrame(animate);
      }

      // Start on title screen
      engine.showTitle();
      fitCanvas();
      animate();
    })();
  </script>
</body>
</html>
