<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#080808">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Proof">
  <title>Proof by Elimination</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
  <link rel="apple-touch-icon" href="icons/icon.svg">
</head>
<body>
  <canvas id="game"></canvas>
  <div id="footer-links">
    <a href="https://abigailhaddad.netlify.app/" target="_blank">website</a>
    <a href="https://presentofcoding.substack.com/" target="_blank">substack</a>
    <a href="https://github.com/abigailhaddad/mathgarden" target="_blank">github</a>
  </div>

  <script src="js/levels.js"></script>
  <script src="js/engine.js"></script>
  <script src="js/sound.js"></script>
  <script src="js/scores.js"></script>
  <script src="js/daily.js"></script>
  <script src="js/renderer.js"></script>
  <script>
    (function() {
      'use strict';

      var canvas = document.getElementById('game');
      var engine = LiarsGarden.createEngine();
      var renderer = LiarsGarden.createRenderer(canvas);
      var STATE = LiarsGarden.STATE;

      function fitCanvas() {
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        renderer.resize(engine.getState());
        renderer.render(engine.getState());
      }
      window.addEventListener('resize', fitCanvas);

      engine.onStateChange = function(gs) {
        renderer.render(gs);
      };

      // Resume audio on any user interaction
      function resumeAudio() {
        if (LiarsGarden.Sound) LiarsGarden.Sound.resume();
      }

      // Keyboard
      document.addEventListener('keydown', function(e) {
        resumeAudio();
        var gs = engine.getState();

        // Title screen: any key starts choosing character
        if (gs.state === STATE.TITLE) {
          if (LiarsGarden.Sound) LiarsGarden.Sound.uiClick();
          engine.chooseCharacter();
          return;
        }

        // Choose character screen: arrow keys + enter
        if (gs.state === STATE.CHOOSE_CHARACTER) {
          var charResult = renderer.handleCharacterKey(e.key);
          if (charResult !== null) {
            if (LiarsGarden.Sound) LiarsGarden.Sound.uiClick();
            engine.selectCharacter(charResult);
          } else {
            renderer.render(engine.getState());
          }
          return;
        }

        // Choose mode screen
        if (gs.state === STATE.CHOOSE_MODE) {
          var modeResult = renderer.handleModeKey(e.key);
          if (modeResult) {
            if (LiarsGarden.Sound) LiarsGarden.Sound.uiClick();
            engine.chooseMode(modeResult);
          } else {
            renderer.render(engine.getState());
          }
          return;
        }

        // Choose difficulty screen
        if (gs.state === STATE.CHOOSE_LIVES) {
          var result = renderer.handleLivesKey(e.key);
          if (result !== null) {
            if (LiarsGarden.Sound) LiarsGarden.Sound.uiClick();
            engine.startGame(result);
          } else {
            renderer.render(engine.getState());
          }
          return;
        }

        if (e.key === 'r' || e.key === 'R') {
          if (gs.state === STATE.GAME_OVER || gs.state === STATE.WIN) {
            engine.restartGame();
          } else {
            engine.restartLevel();
          }
          return;
        }

        var keyMap = {
          ArrowUp: [-1, 0], ArrowDown: [1, 0], ArrowLeft: [0, -1], ArrowRight: [0, 1],
          w: [-1, 0], s: [1, 0], a: [0, -1], d: [0, 1],
          W: [-1, 0], S: [1, 0], A: [0, -1], D: [0, 1],
        };

        if (keyMap[e.key]) {
          e.preventDefault();
          var dir = keyMap[e.key];
          engine.move(dir[0], dir[1]);
        }
      });

      // Mouse click â€” for start button and game over/win
      canvas.addEventListener('click', function(e) {
        resumeAudio();
        var gs = engine.getState();
        var rect = canvas.getBoundingClientRect();
        var mx = e.clientX - rect.left;
        var my = e.clientY - rect.top;

        if (gs.state === STATE.TITLE) {
          var btn = LiarsGarden.createRenderer._titleBtn;
          if (btn) {
            if (mx >= btn.x && mx <= btn.x + btn.w && my >= btn.y && my <= btn.y + btn.h) {
              if (LiarsGarden.Sound) LiarsGarden.Sound.uiClick();
              engine.chooseCharacter();
            }
          }
          return;
        }
        if (gs.state === STATE.CHOOSE_CHARACTER) {
          var charIdx = renderer.handleCharacterClick(mx, my);
          if (charIdx !== null) {
            if (LiarsGarden.Sound) LiarsGarden.Sound.uiClick();
            engine.selectCharacter(charIdx);
          }
          return;
        }
        if (gs.state === STATE.CHOOSE_MODE) {
          var modeResult = renderer.handleModeClick(mx, my);
          if (modeResult) {
            if (LiarsGarden.Sound) LiarsGarden.Sound.uiClick();
            engine.chooseMode(modeResult);
          }
          return;
        }
        if (gs.state === STATE.CHOOSE_LIVES) {
          var livesResult = renderer.handleLivesClick(mx, my);
          if (livesResult !== null && livesResult > 0) {
            if (LiarsGarden.Sound) LiarsGarden.Sound.uiClick();
            engine.startGame(livesResult);
          } else {
            renderer.render(engine.getState());
          }
          return;
        }
        if (gs.state === STATE.GAME_OVER || gs.state === STATE.WIN) {
          // Check share button first
          if (renderer.handleShareClick(mx, my, gs)) {
            renderer.render(gs);
            return;
          }
          engine.restartGame();
          return;
        }
      });

      // Touch
      var touchStartX = 0, touchStartY = 0;
      canvas.addEventListener('touchstart', function(e) {
        resumeAudio();
        var gs = engine.getState();
        if (gs.state === STATE.TITLE || gs.state === STATE.CHOOSE_CHARACTER || gs.state === STATE.CHOOSE_MODE || gs.state === STATE.CHOOSE_LIVES || gs.state === STATE.GAME_OVER || gs.state === STATE.WIN) {
          // Handled by click
          return;
        }
        var t = e.touches[0];
        touchStartX = t.clientX;
        touchStartY = t.clientY;
      }, {passive: true});

      canvas.addEventListener('touchend', function(e) {
        var gs = engine.getState();
        if (gs.state === STATE.TITLE || gs.state === STATE.CHOOSE_CHARACTER || gs.state === STATE.CHOOSE_MODE || gs.state === STATE.CHOOSE_LIVES || gs.state === STATE.GAME_OVER || gs.state === STATE.WIN) return;
        var t = e.changedTouches[0];
        var dx = t.clientX - touchStartX;
        var dy = t.clientY - touchStartY;
        var threshold = 30;

        if (Math.abs(dx) < threshold && Math.abs(dy) < threshold) return;

        if (Math.abs(dx) > Math.abs(dy)) {
          engine.move(0, dx > 0 ? 1 : -1);
        } else {
          engine.move(dy > 0 ? 1 : -1, 0);
        }
      }, {passive: true});

      // Animation loop
      function animate() {
        renderer.render(engine.getState());
        requestAnimationFrame(animate);
      }

      // Start on title screen
      engine.showTitle();
      fitCanvas();
      animate();
    })();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
